pipeline {
    agent any
    
    environment {
        // Docker settings
        DOCKER_IMAGE = 'demo-website'
        DOCKER_TAG = "${BUILD_NUMBER}"
        DOCKER_REGISTRY = 'localhost:5000' // Change to your registry
        
        // SonarQube settings
        SONAR_SERVER = 'SonarQ' // Jenkins SonarQube server name configured in Manage Jenkins
        SONAR_PROJECT_KEY = 'demo-website'
        
        // Application settings
        APP_NAME = 'demo-website'
        APP_PORT = '8080'
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "üîÑ Checking out source code..."
                    checkout scm
                }
            }
        }
        
        stage('Code Quality Analysis') {
            parallel {
                stage('SonarQube Scan') {
                    steps {
                        script {
                            echo "üîç Running SonarQube analysis..."
                            withSonarQubeEnv(SONAR_SERVER) {
                                sh '''
                                    echo "Starting SonarQube analysis for demo website..."
                                    /var/lib/jenkins/tools/hudson.plugins.sonar.SonarRunnerInstallation/SonarQ/bin/sonar-scanner \
                                        -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                                        -Dsonar.projectName="DevOps Demo Website" \
                                        -Dsonar.projectVersion=${BUILD_NUMBER} \
                                        -Dsonar.sources=. \
                                        -Dsonar.exclusions="node_modules/**,**/*.min.js,**/*.min.css,Dockerfile,nginx.conf" \
                                        -Dsonar.sourceEncoding=UTF-8 \
                                        -Dsonar.javascript.file.suffixes=.js \
                                        -Dsonar.css.file.suffixes=.css \
                                        -Dsonar.html.file.suffixes=.html
                                '''
                            }
                        }
                    }
                }
                
                stage('Lint Check') {
                    steps {
                        script {
                            echo "üìù Running lint checks..."
                            sh '''
                                echo "Checking HTML structure..."
                                if grep -q "<!DOCTYPE html>" *.html; then
                                    echo "‚úÖ HTML structure is valid"
                                else
                                    echo "‚ùå HTML structure issues found"
                                    exit 1
                                fi
                                
                                echo "Checking CSS syntax..."
                                if [ -f "styles.css" ]; then
                                    echo "‚úÖ CSS file found"
                                else
                                    echo "‚ùå CSS file missing"
                                    exit 1
                                fi
                                
                                echo "Checking JavaScript syntax..."
                                if [ -f "script.js" ]; then
                                    echo "‚úÖ JavaScript file found"
                                else
                                    echo "‚ùå JavaScript file missing"
                                    exit 1
                                fi
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Quality Gate') {
            steps {
                script {
                    echo "üö™ Waiting for SonarQube Quality Gate..."
                    timeout(time: 5, unit: 'MINUTES') {
                        try {
                            def qg = waitForQualityGate()
                            if (qg.status != 'OK') {
                                echo "‚ö†Ô∏è Quality Gate failed: ${qg.status}"
                                // For demo, continue build anyway
                                echo "üîÑ Continuing build despite Quality Gate failure..."
                            } else {
                                echo "‚úÖ Quality Gate passed!"
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Quality Gate check failed: ${e.getMessage()}"
                            echo "üîÑ Continuing build despite Quality Gate check failure..."
                        }
                    }
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo "üê≥ Building Docker image..."
                    sh '''
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                        docker images | grep ${DOCKER_IMAGE}
                    '''
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                script {
                    echo "üõ°Ô∏è Running security scans..."
                    sh '''
                        if docker run --rm ${DOCKER_IMAGE}:${DOCKER_TAG} whoami | grep -q root; then
                            echo "‚ö†Ô∏è Container runs as root user"
                        else
                            echo "‚úÖ Container does not run as root"
                        fi
                        
                        echo "Exposed ports:"
                        docker inspect ${DOCKER_IMAGE}:${DOCKER_TAG} | grep -i ExposedPorts || echo "No exposed ports"
                    '''
                }
            }
        }
        
        stage('Test Docker Image') {
            steps {
                script {
                    echo "üß™ Testing Docker image..."
                    sh '''
                        CONTAINER_ID=$(docker run -d -p ${APP_PORT}:80 ${DOCKER_IMAGE}:${DOCKER_TAG})
                        sleep 10
                        if curl -f http://localhost:${APP_PORT}/health; then
                            echo "‚úÖ Health check passed"
                        else
                            echo "‚ùå Health check failed"
                            docker logs $CONTAINER_ID
                            docker stop $CONTAINER_ID
                            exit 1
                        fi
                        
                        if curl -f http://localhost:${APP_PORT}/ | grep -q "DevOps Demo"; then
                            echo "‚úÖ Main page test passed"
                        else
                            echo "‚ùå Main page test failed"
                            docker stop $CONTAINER_ID
                            exit 1
                        fi
                        
                        docker stop $CONTAINER_ID
                    '''
                }
            }
        }
        
        stage('Push to Registry') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    expression { return params.FORCE_DEPLOY == true }
                }
            }
            steps {
                script {
                    echo "üì§ Pushing image to registry..."
                    sh '''
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest
                        docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}
                        docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest
                    '''
                }
            }
        }
        
        stage('Deploy') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    expression { return params.FORCE_DEPLOY == true }
                }
            }
            steps {
                script {
                    echo "üöÄ Deploying application..."
                    sh '''
                        docker stop ${APP_NAME} 2>/dev/null || true
                        docker rm ${APP_NAME} 2>/dev/null || true
                        docker run -d --name ${APP_NAME} -p 9090:80 --restart unless-stopped ${DOCKER_IMAGE}:${DOCKER_TAG}
                        sleep 5
                        if curl -f http://localhost:9090/health; then
                            echo "‚úÖ Deployment verification passed"
                        else
                            echo "‚ùå Deployment verification failed"
                            exit 1
                        fi
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "üßπ Cleaning up..."
                sh '''
                    docker image prune -f
                    echo "üìä Build Summary:"
                    echo "- Build Number: ${BUILD_NUMBER}"
                    echo "- Docker Image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                    echo "- SonarQube Project: ${SONAR_PROJECT_KEY}"
                    echo "- Application URL: http://localhost:9090"
                '''
            }
        }
        
        success {
            script {
                echo "‚úÖ Pipeline completed successfully!"
                echo "üéâ Demo website is ready!"
                echo ""
                echo "üìã Access Points:"
                echo "- Website: http://localhost:9090"
                echo "- SonarQube: http://192.168.47.147:9000/dashboard?id=${SONAR_PROJECT_KEY}"
                echo "- Jenkins: ${BUILD_URL}"
            }
        }
        
        failure {
            script {
                echo "‚ùå Pipeline failed!"
                echo "üîç Check logs above for details"
                echo "üìã Troubleshooting:"
                echo "- Verify SonarQube server is reachable"
                echo "- Check Docker daemon status"
                echo "- Confirm dependencies installed"
            }
        }
        
        cleanup {
            script {
                echo "üóëÔ∏è Workspace cleanup completed"
            }
        }
    }
}
